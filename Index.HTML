<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–º–Ω—ã–π –ø–æ–∏—Å–∫ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π (–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 0 20px 20px; }
        .container { max-width: 1400px; margin: 130px auto 20px; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 20px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .header-content { max-width: 1400px; margin: 0 auto; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 300; }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        .search-section { padding: 40px; background: #f8f9fa; }
        .file-upload-section, .advanced-search { background: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e9ecef; }
        .upload-row, .search-row { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .upload-section, .search-field { display: flex; flex-direction: column; gap: 15px; }
        .upload-area { border: 2px dashed #667eea; border-radius: 12px; padding: 40px 20px; text-align: center; background: #f8f9ff; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .upload-area:hover { border-color: #5a6fd8; background: #f0f2ff; }
        .upload-area.dragover { border-color: #28a745; background: #f0f9f0; transform: scale(1.02); }
        .upload-icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.7; }
        .upload-text strong { display: block; font-size: 1.2rem; color: #333; margin-bottom: 8px; }
        .upload-text p { color: #6c757d; font-size: 0.9rem; margin: 0; }
        .upload-btn, .search-btn, .clear-btn, .reset-btn, .clear-data-btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .upload-btn, .search-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .clear-data-btn { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; }
        .upload-status { padding: 15px; border-radius: 8px; text-align: center; font-weight: 600; margin-top: 15px; }
        .upload-status.success { background: #d4edda; color: #155724; }
        .upload-status.error { background: #f8d7da; color: #721c24; }
        .upload-status.loading { background: #d1ecf1; color: #0c5460; }
        .upload-status.warning { background: #fff3cd; color: #856404; }
        .search-field label { font-size: 0.9rem; font-weight: 600; color: #495057; margin-bottom: 8px; }
        .search-select, .search-input { padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: all 0.3s ease; }
        .search-select:focus, .search-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .search-container { display: flex; gap: 15px; margin-bottom: 30px; justify-content: center; }
        .clear-btn { background: #6c757d; color: white; }
        .reset-btn { background: #ffc107; color: #212529; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-number { font-size: 2rem; font-weight: 700; color: #667eea; }
        .stat-label { color: #6c757d; font-size: 0.9rem; margin-top: 5px; }
        .results-section { padding: 0 40px 40px; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .results-title { font-size: 1.5rem; color: #333; font-weight: 600; }
        .export-buttons { display: flex; gap: 15px; }
        .export-btn { padding: 12px 24px; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.3s ease; }
        .excel-btn { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .csv-btn { background: linear-gradient(135deg, #007bff 0%, #6f42c1 100%); }
        .moyoffice-btn { background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%); }
        .result-card { background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 20px; transition: all 0.3s ease; }
        .result-card:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .position-title { font-size: 1.3rem; font-weight: 600; color: #333; margin-bottom: 15px; }
        .result-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .detail-item { display: flex; flex-direction: column; }
        .detail-label { font-size: 0.85rem; color: #6c757d; font-weight: 600; margin-bottom: 5px; text-transform: uppercase; }
        .detail-value { font-size: 1rem; color: #333; word-break: break-word; }
        .department-path { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; margin-top: 15px; }
        .no-results { text-align: center; padding: 60px 20px; color: #6c757d; }
        .loading { text-align: center; padding: 40px; color: #667eea; font-size: 1.2rem; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .initial-message { text-align: center; padding: 40px 20px; background: white; border-radius: 15px; border: 2px dashed #667eea; margin: 20px 0; }
        .active-filters { background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .filter-tag { display: inline-block; background: #2196f3; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; margin: 2px 5px 2px 0; }
        .data-info { background: #e8f4fd; border: 1px solid #b8daff; border-radius: 8px; padding: 15px; margin-top: 15px; }
        .data-info h4 { color: #0c5460; margin-bottom: 10px; }
        .data-info p { color: #0c5460; margin: 0; }
        .format-info { background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-top: 15px; }
        .format-info h4 { color: #0c5460; margin-bottom: 10px; }
        .format-info p { color: #0c5460; margin: 0; font-size: 0.9rem; }
        .format-info.warning { background: #fff3cd; border-color: #ffeaa7; }
        .format-info.warning h4, .format-info.warning p { color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1><i class="fas fa-search"></i> –£–º–Ω—ã–π –ø–æ–∏—Å–∫ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π</h1>
                <p>–°–∏—Å—Ç–µ–º–∞ –ø–æ–∏—Å–∫–∞ –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π —Å –≤–∏—Ç—Ä–∏–Ω–∞–º–∏ –∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞–º–∏</p>
            </div>
        </div>

        <div class="search-section">
            <div class="file-upload-section">
                <h3 style="margin-bottom: 20px; color: #333; font-weight: 600;"><i class="fas fa-folder-open"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
                
                <div id="formatInfo" class="format-info">
                    <h4><i class="fas fa-info-circle"></i> –°—Ç–∞—Ç—É—Å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤</h4>
                    <p id="formatStatus">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫...</p>
                </div>
                
                <div class="upload-container">
                    <div class="upload-row">
                        <div class="upload-section">
                            <h4><i class="fas fa-chart-bar"></i> –í–∏—Ç—Ä–∏–Ω—ã –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π</h4>
                            <div class="upload-area" id="uploadAreaVitriny">
                                <div class="upload-icon"><i class="fas fa-chart-bar"></i></div>
                                <div class="upload-text">
                                    <strong>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –≤–∏—Ç—Ä–∏–Ω —Å—é–¥–∞</strong>
                                    <p id="supportedFormatsVitriny">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: –ø—Ä–æ–≤–µ—Ä–∫–∞...</p>
                                </div>
                                <input type="file" id="fileInputVitriny" style="display: none;">
                            </div>
                            <button class="upload-btn" id="uploadBtnVitriny"><i class="fas fa-file-upload"></i> –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª –≤–∏—Ç—Ä–∏–Ω</button>
                        </div>
                        <div class="upload-section">
                            <h4><i class="fas fa-list-alt"></i> –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π</h4>
                            <div class="upload-area" id="uploadAreaSprav">
                                <div class="upload-icon"><i class="fas fa-list-alt"></i></div>
                                <div class="upload-text">
                                    <strong>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å—é–¥–∞</strong>
                                    <p id="supportedFormatsSprav">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: –ø—Ä–æ–≤–µ—Ä–∫–∞...</p>
                                </div>
                                <input type="file" id="fileInputSprav" style="display: none;">
                            </div>
                            <button class="upload-btn" id="uploadBtnSprav"><i class="fas fa-file-upload"></i> –í—ã–±—Ä–∞—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫</button>
                        </div>
                    </div>
                    <div class="upload-actions">
                        <button class="clear-data-btn" id="clearDataBtn" style="display: none;"><i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
                    </div>
                    <div id="uploadStatus" class="upload-status" style="display: none;"></div>
                </div>
            </div>

            <div class="advanced-search" id="searchSection" style="display: none;">
                <h3 style="margin-bottom: 20px; color: #333; font-weight: 600;"><i class="fas fa-search"></i> –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</h3>
                <div class="search-row">
                    <div class="search-field">
                        <label for="blockFunction">–í—ã–±–µ—Ä–µ—Ç–µ "–ë–ª–æ–∫ —Ñ—É–Ω–∫—Ü–∏–∏"</label>
                        <select id="blockFunction" class="search-select"><option value="">-- –í—Å–µ –±–ª–æ–∫–∏ --</option></select>
                    </div>
                    <div class="search-field">
                        <label for="belonging">–í—ã–±–µ—Ä–µ—Ç–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å</label>
                        <select id="belonging" class="search-select">
                            <option value="">-- –í—Å–µ —Ç–∏–ø—ã --</option>
                            <option value="–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ü–µ–Ω—Ç—Ä">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ü–µ–Ω—Ç—Ä</option>
                            <option value="–§–∏–ª–∏–∞–ª—ã">–§–∏–ª–∏–∞–ª—ã</option>
                            <option value="–û–¶–û">–û–¶–û</option>
                        </select>
                    </div>
                </div>
                <div class="search-row">
                    <div class="search-field">
                        <label for="department">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</label>
                        <input type="text" id="department" class="search-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç...">
                    </div>
                    <div class="search-field">
                        <label for="searchInput">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏</label>
                        <input type="text" class="search-input" id="searchInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –≠–∫—Å–ø–µ—Ä—Ç...">
                    </div>
                </div>
            </div>

            <div class="search-container">
                <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i> –ü–û–ò–°–ö</button>
                <button class="clear-btn" id="clearBtn"><i class="fas fa-eraser"></i> –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="reset-btn" id="resetBtn"><i class="fas fa-undo"></i> –°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>

            <div id="activeFilters" class="active-filters" style="display: none;">
                <h4>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</h4>
                <div id="filtersList"></div>
            </div>

            <div class="stats">
                <div class="stat-card"><span class="stat-number" id="totalVitrinies">0</span><div class="stat-label">–ó–∞–ø–∏—Å–µ–π –≤ –≤–∏—Ç—Ä–∏–Ω–∞—Ö</div></div>
                <div class="stat-card"><span class="stat-number" id="totalPositions">0</span><div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π</div></div>
                <div class="stat-card"><span class="stat-number" id="totalSprav">0</span><div class="stat-label">–ó–∞–ø–∏—Å–µ–π –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ</div></div>
                <div class="stat-card"><span class="stat-number" id="searchResults">0</span><div class="stat-label">–†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞</div></div>
            </div>
        </div>

        <div class="results-section">
            <div id="initialMessage" class="initial-message">
                <h3><i class="fas fa-hand-paper"></i> –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
                <p>–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã —Å –¥–∞–Ω–Ω—ã–º–∏.</p>
            </div>
            <div class="results-header" id="resultsHeader" style="display: none;">
                <h2 class="results-title" id="resultsTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h2>
                <div class="export-buttons">
                    <button class="export-btn excel-btn" id="exportExcelBtn" style="display: none;"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="export-btn csv-btn" id="exportCSVBtn"><i class="fas fa-file-csv"></i> CSV</button>
                    <button class="export-btn moyoffice-btn" id="exportMoyOfficeBtn" style="display: none;"><i class="fas fa-file-alt"></i> –ú–æ–π–û—Ñ–∏—Å</button>
                </div>
            </div>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <script>
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let vitrinyData = [];
        let spravData = [];
        let currentResults = [];
        let vitrinyLoaded = false;
        let spravLoaded = false;
        let vitrinyLoadDate = null;
        let spravLoadDate = null;
        let vitrinyFileName = '';
        let spravFileName = '';
        let xlsxAvailable = false;

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –ø–æ–∏—Å–∫–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π...');
            initializeSystem();
        });

        function initializeSystem() {
            showUploadStatus('‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...', 'loading');
            loadXLSXLibrary();
        }

        function loadXLSXLibrary() {
            console.log('üìö –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ XLSX...');
            
            // –°–ø–∏—Å–æ–∫ CDN –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ XLSX –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            const xlsxSources = [
                'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
                'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'
            ];
            
            let sourceIndex = 0;
            
            function tryLoadSource() {
                if (sourceIndex >= xlsxSources.length) {
                    console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å XLSX –±–∏–±–ª–∏–æ—Ç–µ–∫—É –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤');
                    initializeWithoutXLSX();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = xlsxSources[sourceIndex];
                script.onload = function() {
                    console.log('‚úÖ XLSX –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑:', xlsxSources[sourceIndex]);
                    xlsxAvailable = true;
                    initializeWithXLSX();
                };
                script.onerror = function() {
                    console.warn('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑:', xlsxSources[sourceIndex]);
                    sourceIndex++;
                    tryLoadSource();
                };
                document.head.appendChild(script);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ —É–∂–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
            if (typeof XLSX !== 'undefined') {
                console.log('‚úÖ XLSX –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–∂–µ –¥–æ—Å—Ç—É–ø–Ω–∞');
                xlsxAvailable = true;
                initializeWithXLSX();
            } else {
                tryLoadSource();
            }
        }

        function initializeWithXLSX() {
            console.log('üéâ –ü–æ–ª–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤');
            xlsxAvailable = true;
            updateFormatSupport(true);
            finishInitialization();
        }

        function initializeWithoutXLSX() {
            console.log('‚ö†Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤');
            xlsxAvailable = false;
            updateFormatSupport(false);
            finishInitialization();
        }

        function updateFormatSupport(hasXLSX) {
            const formatInfo = document.getElementById('formatInfo');
            const formatStatus = document.getElementById('formatStatus');
            const supportedFormatsVitriny = document.getElementById('supportedFormatsVitriny');
            const supportedFormatsSprav = document.getElementById('supportedFormatsSprav');
            const fileInputVitriny = document.getElementById('fileInputVitriny');
            const fileInputSprav = document.getElementById('fileInputSprav');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const exportMoyOfficeBtn = document.getElementById('exportMoyOfficeBtn');

            if (hasXLSX) {
                formatInfo.className = 'format-info';
                formatStatus.textContent = '‚úÖ –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞: Excel (.xlsx, .xlsm, .xls, .ods) –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã (.csv, .tsv, .txt)';
                supportedFormatsVitriny.textContent = '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: .xlsx, .xlsm, .xls, .ods, .csv, .tsv, .txt';
                supportedFormatsSprav.textContent = '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: .xlsx, .xlsm, .xls, .ods, .csv, .tsv, .txt';
                fileInputVitriny.accept = '.xlsx,.xlsm,.xls,.xods,.ods,.csv,.tsv,.txt';
                fileInputSprav.accept = '.xlsx,.xlsm,.xls,.xods,.ods,.csv,.tsv,.txt';
                exportExcelBtn.style.display = 'inline-block';
                exportMoyOfficeBtn.style.display = 'inline-block';
            } else {
                formatInfo.className = 'format-info warning';
                formatStatus.textContent = '‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞: —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã (.csv, .tsv, .txt). –î–ª—è Excel —Ñ–∞–π–ª–æ–≤ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏—Ö –∫–∞–∫ CSV.';
                supportedFormatsVitriny.textContent = '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: .csv, .tsv, .txt (–¥–ª—è Excel —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ CSV)';
                supportedFormatsSprav.textContent = '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: .csv, .tsv, .txt (–¥–ª—è Excel —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ CSV)';
                fileInputVitriny.accept = '.csv,.tsv,.txt';
                fileInputSprav.accept = '.csv,.tsv,.txt';
                exportExcelBtn.style.display = 'none';
                exportMoyOfficeBtn.style.display = 'none';
            }
        }

        function finishInitialization() {
            try {
                setupFileUpload();
                setupEventListeners();
                console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
                showUploadStatus('üéâ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞! –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.', 'success');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showUploadStatus(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
            }
        }

        // --- –ù–ê–°–¢–†–û–ô–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –°–û–ë–´–¢–ò–ô ---
        function setupFileUpload() {
            const setupArea = (type) => {
                const fileInput = document.getElementById(`fileInput${type}`);
                const uploadArea = document.getElementById(`uploadArea${type}`);
                const uploadBtn = document.getElementById(`uploadBtn${type}`);
                if (!fileInput || !uploadArea || !uploadBtn) return;

                uploadArea.addEventListener('click', () => fileInput.click());
                uploadBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => handleFileSelect(e, type));
                ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (eventName === 'dragover') uploadArea.classList.add('dragover');
                        if (eventName === 'dragleave' || eventName === 'drop') uploadArea.classList.remove('dragover');
                        if (eventName === 'drop') handleFileDrop(e, type);
                    });
                });
            };
            setupArea('Vitriny');
            setupArea('Sprav');
        }

        function setupEventListeners() {
            document.getElementById('searchBtn')?.addEventListener('click', searchPositions);
            document.getElementById('clearBtn')?.addEventListener('click', clearResults);
            document.getElementById('resetBtn')?.addEventListener('click', resetFilters);
            document.getElementById('clearDataBtn')?.addEventListener('click', clearAllData);
            document.getElementById('exportExcelBtn')?.addEventListener('click', exportToExcel);
            document.getElementById('exportCSVBtn')?.addEventListener('click', exportToCSV);
            document.getElementById('exportMoyOfficeBtn')?.addEventListener('click', exportToMoyOffice);
            
            ['searchInput', 'department'].forEach(id => {
                 document.getElementById(id).addEventListener('keypress', e => { if (e.key === 'Enter') searchPositions(); });
            });
             ['blockFunction', 'belonging'].forEach(id => {
                document.getElementById(id).addEventListener('change', searchPositions);
            });
        }

        // --- –õ–û–ì–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò –§–ê–ô–õ–û–í ---
        function handleFileSelect(event, type) {
            const file = event.target.files[0];
            if (file) processFile(file, type);
        }

        function handleFileDrop(event, type) {
            const files = event.dataTransfer.files;
            if (files.length > 0) processFile(files[0], type);
        }

        function processFile(file, type) {
            const fileTypeName = type === 'Vitriny' ? '–≤–∏—Ç—Ä–∏–Ω' : '—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞';
            const extension = file.name.toLowerCase().split('.').pop();
            
            showUploadStatus(`–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ ${fileTypeName}...`, 'loading');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ñ–æ—Ä–º–∞—Ç–∞
            const excelFormats = ['xlsx', 'xlsm', 'xls', 'xods', 'ods'];
            const textFormats = ['csv', 'tsv', 'txt'];
            
            if (excelFormats.includes(extension) && !xlsxAvailable) {
                showUploadStatus(`‚ùå Excel —Ñ–∞–π–ª—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª –∫–∞–∫ CSV –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`, 'error');
                return;
            }
            
            if (!excelFormats.includes(extension) && !textFormats.includes(extension)) {
                showUploadStatus(`‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: .${extension}`, 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    console.log(`–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–∞ ${file.name} —Ç–∏–ø–∞ ${type}`);
                    let jsonData;
                    
                    if (excelFormats.includes(extension)) {
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Excel —Ñ–∞–π–ª–æ–≤
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                            throw new Error('–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏—Å—Ç–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏');
                        }
                        
                        const sheetName = workbook.SheetNames[0];
                        console.log(`–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª–∏—Å—Ç: ${sheetName}`);
                        jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1});
                    } else {
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
                        const content = e.target.result;
                        jsonData = parseCSV(content);
                    }
                    
                    console.log(`–ü–æ–ª—É—á–µ–Ω–æ ${jsonData.length} —Å—Ç—Ä–æ–∫ –∏–∑ —Ñ–∞–π–ª–∞`);
                    
                    if (jsonData.length === 0) {
                        throw new Error('–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö');
                    }
                    
                    processTableData(jsonData, file.name, type);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ–∞–π–ª–∞:', error);
                    showUploadStatus(`‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = (error) => {
                console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞:', error);
                showUploadStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª.', 'error');
            };
            
            if (excelFormats.includes(extension)) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        }

        // --- –ü–ê–†–°–ò–ù–ì CSV ---
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const result = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const delimiter = line.includes(';') ? ';' : ',';
                const cells = [];
                let currentCell = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === delimiter && !inQuotes) {
                        cells.push(currentCell.trim());
                        currentCell = '';
                    } else {
                        currentCell += char;
                    }
                }
                cells.push(currentCell.trim());
                
                const cleanedCells = cells.map(cell => cell.replace(/^"|"$/g, ''));
                result.push(cleanedCells);
            }
            
            return result;
        }

        function processTableData(jsonData, fileName, type) {
            try {
                console.log(`–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞ ${fileName}, —Ç–∏–ø: ${type}`);
                
                if (type === 'Vitriny') {
                    vitrinyData = processVitrinyData(jsonData);
                    vitrinyLoaded = true;
                    vitrinyFileName = fileName;
                    vitrinyLoadDate = new Date();
                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${vitrinyData.length} –∑–∞–ø–∏—Å–µ–π –≤–∏—Ç—Ä–∏–Ω`);
                } else {
                    spravData = processSpravData(jsonData);
                    spravLoaded = true;
                    spravFileName = fileName;
                    spravLoadDate = new Date();
                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${spravData.length} –∑–∞–ø–∏—Å–µ–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞`);
                }
                
                showUploadStatus(`‚úÖ –§–∞–π–ª "${fileName}" –∑–∞–≥—Ä—É–∂–µ–Ω.`, 'success');
                document.getElementById('searchSection').style.display = 'block';
                document.getElementById('clearDataBtn').style.display = 'inline-block';
                updateStatsDisplay();
                
                if (vitrinyLoaded) initializeDropdowns();
                if (vitrinyLoaded && spravLoaded) enrichVitrinyWithSprav();
                
                showDataInfo(); 
                
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞ ${fileName}:`, error);
                showUploadStatus(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: ${error.message}`, 'error');
                
                if (type === 'Vitriny') {
                    vitrinyLoaded = false;
                    vitrinyData = [];
                } else {
                    spravLoaded = false;
                    spravData = [];
                }
            }
        }

        function cleanString(str) {
            if (!str) return '';
            return str.toString().replace(/\u00A0/g, ' ').trim();
        }

        function processVitrinyData(jsonData) {
            const headers = jsonData[0];
            const mapping = findColumnMapping(headers);
            if (mapping.position === undefined) throw new Error('–ö–æ–ª–æ–Ω–∫–∞ "–î–æ–ª–∂–Ω–æ—Å—Ç—å" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ñ–∞–π–ª–µ –≤–∏—Ç—Ä–∏–Ω.');
            
            return jsonData.slice(1).map(row => {
                const position = cleanString(row[mapping.position]);
                if (!position) return null;

                const departmentParts = headers.map((h, i) => (h && h.toLowerCase().includes('–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏') && row[i] ? cleanString(row[i]) : null)).filter(Boolean);
                
                return {
                    position: position,
                    systemName: cleanString(row[mapping.systemName]),
                    okz: cleanString(row[mapping.okz]),
                    block: cleanString(row[mapping.block]),
                    belonging: cleanString(row[mapping.belonging]),
                    department: departmentParts.join('/'),
                    comment: cleanString(row[mapping.comment]),
                    note: cleanString(row[mapping.note])
                };
            }).filter(Boolean);
        }
        
        function processSpravData(jsonData) {
            try {
                if (!jsonData || jsonData.length < 2) {
                    throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞');
                }

                // –î–ª—è CSV —Ñ–∞–π–ª–æ–≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ —Å—Ç—Ä–æ–∫–µ 0, –¥–ª—è Excel –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Å—Ç—Ä–æ–∫–µ 6
                let headerRowIndex = 0;
                let dataStartIndex = 1;
                
                // –ï—Å–ª–∏ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ —Ñ–∞–π–ª –∏–∑ Excel (–º–Ω–æ–≥–æ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫), –∏—â–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                if (jsonData.length > 10 && jsonData[0].length === 1 && jsonData[0][0] && jsonData[0][0].includes('–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫')) {
                    // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
                    for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                        const row = jsonData[i];
                        if (row && row.length > 3 && row.some(cell => cell && cell.toLowerCase().includes('–¥–æ–ª–∂–Ω–æ—Å—Ç'))) {
                            headerRowIndex = i;
                            dataStartIndex = i + 1;
                            console.log(`–ù–∞–π–¥–µ–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ —Å—Ç—Ä–æ–∫–µ ${i}`);
                            break;
                        }
                    }
                }

                const headers = jsonData[headerRowIndex];
                if (!headers || headers.length === 0) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ —Ñ–∞–π–ª–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞');
                }

                const mapping = findSpravColumnMapping(headers);
                console.log('Mapping for —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫:', mapping);
                
                if (mapping.position === undefined) {
                    console.error('–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏:', headers);
                    throw new Error('–ö–æ–ª–æ–Ω–∫–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');
                }
                
                const processedData = jsonData.slice(dataStartIndex).map((row, index) => {
                    if (!row || row.length === 0) return null;
                    
                    const position = cleanString(row[mapping.position]);
                    if (!position) return null;
                    
                    return {
                        position: position,
                        systemName: cleanString(row[mapping.systemName]),
                        fullName: cleanString(row[mapping.fullName]),
                        okzCode: cleanString(row[mapping.okzCode])
                    };
                }).filter(Boolean);

                console.log(`–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${processedData.length} –∑–∞–ø–∏—Å–µ–π –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞`);
                return processedData;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞:', error);
                throw error;
            }
        }
        
        function findColumnMapping(headers) {
            const mapping = {};
            const keywords = { position: ['–¥–æ–ª–∂–Ω–æ—Å—Ç'], systemName: ['—Å–∏—Å—Ç–µ–º–Ω'], okz: ['–æ–∫–∑'], block: ['–±–ª–æ–∫ —Ñ—É–Ω–∫—Ü'], belonging: ['–ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç'], comment: ['–∫–æ–º–º–µ–Ω—Ç–∞—Ä'], note: ['–ø—Ä–∏–º–µ—á–∞–Ω'] };
            headers.forEach((h, i) => {
                if (!h) return;
                const header = h.toLowerCase();
                for (const key in keywords) {
                    if (keywords[key].some(kw => header.includes(kw)) && mapping[key] === undefined) mapping[key] = i;
                }
            });
            return mapping;
        }

        function findSpravColumnMapping(headers) {
            const mapping = {};
            const keywords = { 
                position: ['—Å–∏—Å—Ç–µ–º–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–¥–æ–ª–∂–Ω–æ—Å—Ç'], 
                systemName: ['—Å–∏—Å—Ç–µ–º–Ω–æ–µ –∏–º—è', '—Å–∏—Å—Ç–µ–º–Ω'], 
                fullName: ['–ø–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–ø–æ–ª–Ω'], 
                okzCode: ['–∫–æ–¥ –æ–∫–∑', '–æ–∫–∑'] 
            };
            
            console.log('–ü–æ–∏—Å–∫ –∫–æ–ª–æ–Ω–æ–∫ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ. –ó–∞–≥–æ–ª–æ–≤–∫–∏:', headers);
            
            headers.forEach((h, i) => {
                if (!h) return;
                const header = h.toLowerCase().trim();
                
                for (const [key, keywordList] of Object.entries(keywords)) {
                    if (keywordList.some(kw => header.includes(kw.toLowerCase())) && mapping[key] === undefined) {
                        mapping[key] = i;
                        console.log(`–ù–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ ${key}: –∏–Ω–¥–µ–∫—Å ${i}, –∑–∞–≥–æ–ª–æ–≤–æ–∫ "${h}"`);
                    }
                }
            });
            
            return mapping;
        }

        function enrichVitrinyWithSprav() {
            if (!vitrinyLoaded || !spravLoaded) return;

            try {
                console.log('–ù–∞—á–∏–Ω–∞–µ–º –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤–∏—Ç—Ä–∏–Ω —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–º');
                console.log(`–í–∏—Ç—Ä–∏–Ω—ã: ${vitrinyData.length} –∑–∞–ø–∏—Å–µ–π, –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫: ${spravData.length} –∑–∞–ø–∏—Å–µ–π`);

                // –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ø–æ–∏—Å–∫–∞
                const spravIndexExact = new Map();
                const spravIndexNormalized = new Map();
                const spravIndexWords = new Map();
                
                spravData.forEach((item, index) => {
                    if (item && item.position) {
                        const originalKey = item.position.toLowerCase().trim();
                        const normalizedKey = normalizePosition(item.position);
                        const wordsKey = getPositionWords(item.position);
                        
                        spravIndexExact.set(originalKey, item);
                        spravIndexNormalized.set(normalizedKey, item);
                        if (wordsKey.length > 0) {
                            spravIndexWords.set(wordsKey, item);
                        }
                    }
                });

                console.log(`–°–æ–∑–¥–∞–Ω –∏–Ω–¥–µ–∫—Å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞:`);
                console.log(`- –¢–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è: ${spravIndexExact.size}`);
                console.log(`- –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ: ${spravIndexNormalized.size}`);
                console.log(`- –ü–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º: ${spravIndexWords.size}`);
                
                let matches = 0;
                let processed = 0;
                const matchDetails = [];

                vitrinyData.forEach((item, index) => {
                    processed++;
                    
                    if (!item || !item.position) {
                        return;
                    }

                    let match = null;
                    let matchType = '';

                    // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                    const exactKey = item.position.toLowerCase().trim();
                    match = spravIndexExact.get(exactKey);
                    if (match) {
                        matchType = '—Ç–æ—á–Ω–æ–µ';
                    }

                    // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                    if (!match) {
                        const normalizedKey = normalizePosition(item.position);
                        match = spravIndexNormalized.get(normalizedKey);
                        if (match) {
                            matchType = '–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ';
                        }
                    }

                    // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 3: –ü–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
                    if (!match) {
                        const wordsKey = getPositionWords(item.position);
                        if (wordsKey.length > 0) {
                            match = spravIndexWords.get(wordsKey);
                            if (match) {
                                matchType = '–ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º';
                            }
                        }
                    }

                    // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 4: –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–ª–æ–≤–∞ —Å–æ–≤–ø–∞–¥–∞—é—Ç)
                    if (!match) {
                        const itemWords = getPositionWords(item.position);
                        for (const [key, spravItem] of spravIndexWords.entries()) {
                            if (itemWords.length > 0 && key === itemWords) {
                                match = spravItem;
                                matchType = '—á–∞—Å—Ç–∏—á–Ω–æ–µ';
                                break;
                            }
                        }
                    }

                    if (match) {
                        matches++;
                        
                        if (match.systemName && match.systemName !== item.systemName) {
                            item.systemName = match.systemName;
                        }
                        if (match.okzCode && match.okzCode !== item.okz) {
                            item.okz = match.okzCode;
                        }
                        if (match.fullName && match.fullName !== item.fullPositionName) {
                            item.fullPositionName = match.fullName;
                        }
                        
                        if (matches <= 10) {
                            matchDetails.push({
                                type: matchType,
                                vitriny: item.position,
                                sprav: match.position,
                                systemName: match.systemName
                            });
                            console.log(`–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ ${matches} (${matchType}): "${item.position}" -> "${match.position}" -> —Å–∏—Å—Ç–µ–º–Ω–æ–µ –∏–º—è: "${match.systemName}"`);
                        }
                    }
                });

                console.log(`–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${processed}, –Ω–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: ${matches}`);
                console.log('–î–µ—Ç–∞–ª–∏ –ø–µ—Ä–≤—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:', matchDetails);

                if (matches > 0) {
                    showUploadStatus(`üîó –î–∞–Ω–Ω—ã–µ –æ–±–æ–≥–∞—â–µ–Ω—ã. –ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: ${matches} –∏–∑ ${processed}`, 'success');
                } else {
                    showUploadStatus('‚ö†Ô∏è –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –º–µ–∂–¥—É –≤–∏—Ç—Ä–∏–Ω–∞–º–∏ –∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏—á–∏–Ω...', 'warning');
                    
                    // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    console.log('=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –û–¢–°–£–¢–°–¢–í–ò–Ø –°–û–í–ü–ê–î–ï–ù–ò–ô ===');
                    console.log('–ü—Ä–∏–º–µ—Ä—ã –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π –∏–∑ –≤–∏—Ç—Ä–∏–Ω:');
                    vitrinyData.slice(0, 10).forEach((item, i) => {
                        if (item && item.position) {
                            console.log(`${i+1}. "${item.position}" -> –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ: "${normalizePosition(item.position)}" -> —Å–ª–æ–≤–∞: "${getPositionWords(item.position)}"`);
                        }
                    });
                    
                    console.log('\n–ü—Ä–∏–º–µ—Ä—ã –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞:');
                    spravData.slice(0, 10).forEach((item, i) => {
                        if (item && item.position) {
                            console.log(`${i+1}. "${item.position}" -> –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ: "${normalizePosition(item.position)}" -> —Å–ª–æ–≤–∞: "${getPositionWords(item.position)}"`);
                        }
                    });
                }
                
                updateStatsDisplay();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–æ–≥–∞—â–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showUploadStatus(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–æ–≥–∞—â–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏–π –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π
        function normalizePosition(position) {
            if (!position) return '';
            return position
                .toLowerCase()
                .trim()
                .replace(/[^\w\s\u0400-\u04FF]/g, ' ') // –£–±–∏—Ä–∞–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∏—Ä–∏–ª–ª–∏—Ü—É –∏ –ª–∞—Ç–∏–Ω–∏—Ü—É
                .replace(/\s+/g, ' ') // –£–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
                .trim();
        }

        // –§—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏–∑ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
        function getPositionWords(position) {
            if (!position) return '';
            
            const stopWords = ['–ø–æ', '–≤', '–Ω–∞', '—Å', '–¥–ª—è', '–æ—Ç', '–∫', '–∏', '–∏–ª–∏', '–∞', '–Ω–æ', '–¥–∞', '–Ω–µ—Ç', '–Ω–µ', '–∫–∞–∫', '—á—Ç–æ', '–≥–¥–µ'];
            
            return normalizePosition(position)
                .split(' ')
                .filter(word => word.length > 2 && !stopWords.includes(word))
                .sort()
                .join(' ');
        }

        // --- –õ–û–ì–ò–ö–ê –ü–û–ò–°–ö–ê ---
        function searchPositions() {
            if (!vitrinyLoaded) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –≤–∏—Ç—Ä–∏–Ω');
                return;
            }
            
            try {
                showLoading();
                setTimeout(() => {
                    try {
                        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
                        const block = document.getElementById('blockFunction').value;
                        const belonging = document.getElementById('belonging').value;
                        const department = document.getElementById('department').value.trim().toLowerCase();
                        
                        currentResults = vitrinyData.filter(item => {
                            if (!item) return false;
                            
                            const matchesSearchTerm = !searchTerm || 
                                (item.position && item.position.toLowerCase().includes(searchTerm)) || 
                                (item.systemName && item.systemName.toLowerCase().includes(searchTerm));
                                
                            const matchesBlock = !block || item.block === block;
                            const matchesBelonging = !belonging || item.belonging === belonging;
                            const matchesDepartment = !department || 
                                (item.department && item.department.toLowerCase().includes(department));
                            
                            return matchesSearchTerm && matchesBlock && matchesBelonging && matchesDepartment;
                        });
                        
                        displayResults();
                        updateStatsDisplay();
                        displayActiveFilters({searchTerm, block, belonging, department});
                        
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞:', error);
                        document.getElementById('resultsContainer').innerHTML = `
                            <div class="no-results">
                                <h3><i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</h3>
                                <p>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞: ${error.message}</p>
                            </div>`;
                    }
                }, 200);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞');
            }
        }

        // --- –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –ò –°–¢–ê–¢–£–°–û–í ---
        function showDataInfo() {
            const uploadContainer = document.querySelector('.upload-container');
            if (!uploadContainer) return;

            let infoDiv = uploadContainer.querySelector('.data-info');
            if (infoDiv) {
                infoDiv.remove();
            }

            if (!vitrinyLoaded && !spravLoaded) return;

            infoDiv = document.createElement('div');
            infoDiv.className = 'data-info';
            
            let infoHTML = '<h4><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–∞—Ö</h4>';
            
            if (vitrinyLoaded) {
                const dateStr = vitrinyLoadDate ? vitrinyLoadDate.toLocaleString('ru-RU') : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                infoHTML += `<p style="margin-bottom: 5px;"><strong>–í–∏—Ç—Ä–∏–Ω—ã:</strong> ${vitrinyFileName} (–∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${dateStr})</p>`;
            }
            if (spravLoaded) {
                 const dateStr = spravLoadDate ? spravLoadDate.toLocaleString('ru-RU') : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                infoHTML += `<p><strong>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫:</strong> ${spravFileName} (–∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${dateStr})</p>`;
            }
            
            infoDiv.innerHTML = infoHTML;
            uploadContainer.appendChild(infoDiv);
        }
		
		function displayResults() {
            const container = document.getElementById('resultsContainer');
            const header = document.getElementById('resultsHeader');
            document.getElementById('initialMessage').style.display = 'none';

            if (currentResults.length === 0) {
                container.innerHTML = `<div class="no-results"><h3><i class="fas fa-search"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3><p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞.</p></div>`;
                header.style.display = 'none';
                return;
            }

            header.style.display = 'flex';
            document.getElementById('resultsTitle').textContent = `–ù–∞–π–¥–µ–Ω–æ ${currentResults.length} –∑–∞–ø–∏—Å–µ–π`;
            
            container.innerHTML = currentResults.map(result => `
                <div class="result-card">
                    <div class="position-title">${result.position}</div>
                    <div class="result-details">
                        <div class="detail-item"><div class="detail-label">–°–∏—Å—Ç–µ–º–Ω–æ–µ –∏–º—è</div><div class="detail-value">${result.systemName || '‚Äî'}</div></div>
                        <div class="detail-item"><div class="detail-label">–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</div><div class="detail-value">${result.fullPositionName || '‚Äî'}</div></div>
                        <div class="detail-item"><div class="detail-label">–û–ö–ó</div><div class="detail-value">${result.okz || '‚Äî'}</div></div>
                        <div class="detail-item"><div class="detail-label">–ë–ª–æ–∫ —Ñ—É–Ω–∫—Ü–∏–∏</div><div class="detail-value">${result.block || '‚Äî'}</div></div>
                        <div class="detail-item"><div class="detail-label">–ü—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å</div><div class="detail-value">${result.belonging || '‚Äî'}</div></div>
                    </div>
                    <div class="department-path"><div class="detail-label">–ü—É—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</div><div class="detail-value">${result.department || '‚Äî'}</div></div>
                    ${result.comment ? `<div class="department-path" style="border-left-color: #17a2b8; background: #d1ecf1;"><div class="detail-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div><div class="detail-value">${result.comment}</div></div>` : ''}
                    ${result.note ? `<div class="department-path" style="border-left-color: #ffc107; background: #fff3cd;"><div class="detail-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</div><div class="detail-value">${result.note}</div></div>` : ''}
                </div>
            `).join('');
        }
        
        function showLoading() {
            document.getElementById('resultsContainer').innerHTML = `<div class="loading"><div class="spinner"></div>–ü–æ–∏—Å–∫...</div>`;
        }
        
        function clearResults() {
            currentResults = [];
            document.getElementById('resultsContainer').innerHTML = '';
            document.getElementById('resultsHeader').style.display = 'none';
            document.getElementById('initialMessage').style.display = 'block';
            updateStatsDisplay();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('department').value = '';
            document.getElementById('blockFunction').value = '';
            document.getElementById('belonging').value = '';
            displayActiveFilters({});
            clearResults();
        }
        
        function clearAllData() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')) return;
            vitrinyData = []; spravData = [];
            vitrinyLoaded = false; spravLoaded = false;
            vitrinyLoadDate = null; spravLoadDate = null;
            vitrinyFileName = ''; spravFileName = '';
            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('clearDataBtn').style.display = 'none';
            resetFilters();
            updateStatsDisplay();
            showDataInfo();
            showUploadStatus('üóëÔ∏è –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã.', 'success');
        }

        function updateStatsDisplay() {
            document.getElementById('totalVitrinies').textContent = vitrinyData.length;
            document.getElementById('totalPositions').textContent = new Set(vitrinyData.map(i => i.position)).size;
            document.getElementById('totalSprav').textContent = spravData.length;
            document.getElementById('searchResults').textContent = currentResults.length;
        }
        
        function initializeDropdowns() {
            const uniqueBlocks = [...new Set(vitrinyData.map(item => item.block).filter(Boolean))].sort();
            const blockSelect = document.getElementById('blockFunction');
            blockSelect.innerHTML = '<option value="">-- –í—Å–µ –±–ª–æ–∫–∏ --</option>';
            uniqueBlocks.forEach(block => {
                const option = document.createElement('option');
                option.value = block;
                option.textContent = block;
                blockSelect.appendChild(option);
            });
        }
        
        function displayActiveFilters(filters) {
            const container = document.getElementById('activeFilters');
            const list = document.getElementById('filtersList');
            list.innerHTML = '';
            let hasFilters = false;
            for (const key in filters) {
                if (filters[key]) {
                    hasFilters = true;
                    const tag = document.createElement('span');
                    tag.className = 'filter-tag';
                    tag.textContent = `${key}: ${filters[key]}`;
                    list.appendChild(tag);
                }
            }
            container.style.display = hasFilters ? 'block' : 'none';
        }
        
        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            if (!statusDiv) return;
            statusDiv.textContent = message;
            statusDiv.className = `upload-status ${type}`;
            statusDiv.style.display = 'block';
            if (type !== 'loading') setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
        }

        // --- –§–£–ù–ö–¶–ò–ò –≠–ö–°–ü–û–†–¢–ê ---
        function createExportData() {
            if (currentResults.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.');
                return null;
            }

            const headers = [
                '–î–æ–ª–∂–Ω–æ—Å—Ç—å', '–°–∏—Å—Ç–µ–º–Ω–æ–µ –∏–º—è', '–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–û–ö–ó', 
                '–ë–ª–æ–∫ —Ñ—É–Ω–∫—Ü–∏–∏', '–ü—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å', 
                '–ü—É—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', '–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ'
            ];
            
            const data = [headers];

            currentResults.forEach(item => {
                const row = [
                    item.position || '',
                    item.systemName || '',
                    item.fullPositionName || '',
                    item.okz || '',
                    item.block || '',
                    item.belonging || '',
                    item.department || '',
                    item.comment || '',
                    item.note || ''
                ];
                data.push(row);
            });

            return data;
        }

        function exportToExcel() {
            try {
                if (!xlsxAvailable) {
                    alert('Excel —ç–∫—Å–ø–æ—Ä—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ CSV —ç–∫—Å–ø–æ—Ä—Ç.');
                    return;
                }
                
                const data = createExportData();
                if (!data) return;

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [ {wch:30}, {wch:30}, {wch:40}, {wch:15}, {wch:30}, {wch:20}, {wch:50}, {wch:40}, {wch:40} ];
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã");
                XLSX.writeFile(wb, "export_results.xlsx");
                showUploadStatus('‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel –∑–∞–≤–µ—Ä—à–µ–Ω.', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel:', error);
                showUploadStatus(`‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel: ${error.message}`, 'error');
            }
        }

        function exportToCSV() {
            try {
                const data = createExportData();
                if (!data) return;

                const csvContent = data.map(row => 
                    row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(',')
                ).join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'export_results.csv';
                link.click();
                showUploadStatus('‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV –∑–∞–≤–µ—Ä—à–µ–Ω.', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ CSV:', error);
                showUploadStatus(`‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ CSV: ${error.message}`, 'error');
            }
        }

        function exportToMoyOffice() {
            try {
                if (!xlsxAvailable) {
                    alert('–ú–æ–π–û—Ñ–∏—Å —ç–∫—Å–ø–æ—Ä—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ CSV —ç–∫—Å–ø–æ—Ä—Ç.');
                    return;
                }
                
                const data = createExportData();
                if (!data) return;

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [ {wch:30}, {wch:30}, {wch:40}, {wch:15}, {wch:30}, {wch:20}, {wch:50}, {wch:40}, {wch:40} ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã");
                XLSX.writeFile(wb, "export_results.ods", { bookType: 'ods' });
                showUploadStatus('‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –≤ –ú–æ–π–û—Ñ–∏—Å (.ods) –∑–∞–≤–µ—Ä—à–µ–Ω.', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ –ú–æ–π–û—Ñ–∏—Å:', error);
                showUploadStatus(`‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ –ú–æ–π–û—Ñ–∏—Å: ${error.message}`, 'error');
            }
        }

    </script>
</body>
</html>
