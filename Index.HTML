<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Умный поиск должностей (Универсальная версия)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 0 20px 20px; }
        .container { max-width: 1400px; margin: 130px auto 20px; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 20px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .header-content { max-width: 1400px; margin: 0 auto; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 300; }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        .search-section { padding: 40px; background: #f8f9fa; }
        .file-upload-section, .advanced-search { background: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e9ecef; }
        .upload-row, .search-row { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .upload-section, .search-field { display: flex; flex-direction: column; gap: 15px; }
        .upload-area { border: 2px dashed #667eea; border-radius: 12px; padding: 40px 20px; text-align: center; background: #f8f9ff; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .upload-area:hover { border-color: #5a6fd8; background: #f0f2ff; }
        .upload-area.dragover { border-color: #28a745; background: #f0f9f0; transform: scale(1.02); }
        .upload-icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.7; }
        .upload-text strong { display: block; font-size: 1.2rem; color: #333; margin-bottom: 8px; }
        .upload-text p { color: #6c757d; font-size: 0.9rem; margin: 0; }
        .upload-btn, .search-btn, .clear-btn, .reset-btn, .clear-data-btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .upload-btn, .search-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .clear-data-btn { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; }
        .upload-status { padding: 15px; border-radius: 8px; text-align: center; font-weight: 600; margin-top: 15px; }
        .upload-status.success { background: #d4edda; color: #155724; }
        .upload-status.error { background: #f8d7da; color: #721c24; }
        .upload-status.loading { background: #d1ecf1; color: #0c5460; }
        .upload-status.warning { background: #fff3cd; color: #856404; }
        .search-field label { font-size: 0.9rem; font-weight: 600; color: #495057; margin-bottom: 8px; }
        .search-select, .search-input { padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: all 0.3s ease; }
        .search-select:focus, .search-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .search-container { display: flex; gap: 15px; margin-bottom: 30px; justify-content: center; }
        .clear-btn { background: #6c757d; color: white; }
        .reset-btn { background: #ffc107; color: #212529; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-number { font-size: 2rem; font-weight: 700; color: #667eea; }
        .stat-label { color: #6c757d; font-size: 0.9rem; margin-top: 5px; }
        .results-section { padding: 0 40px 40px; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .results-title { font-size: 1.5rem; color: #333; font-weight: 600; }
        .export-buttons { display: flex; gap: 15px; }
        .export-btn { padding: 12px 24px; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.3s ease; }
        .excel-btn { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .csv-btn { background: linear-gradient(135deg, #007bff 0%, #6f42c1 100%); }
        .moyoffice-btn { background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%); }
        .result-card { background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 20px; transition: all 0.3s ease; }
        .result-card:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .position-title { font-size: 1.3rem; font-weight: 600; color: #333; margin-bottom: 15px; }
        .result-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .detail-item { display: flex; flex-direction: column; }
        .detail-label { font-size: 0.85rem; color: #6c757d; font-weight: 600; margin-bottom: 5px; text-transform: uppercase; }
        .detail-value { font-size: 1rem; color: #333; word-break: break-word; }
        .department-path { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; margin-top: 15px; }
        .no-results { text-align: center; padding: 60px 20px; color: #6c757d; }
        .loading { text-align: center; padding: 40px; color: #667eea; font-size: 1.2rem; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .initial-message { text-align: center; padding: 40px 20px; background: white; border-radius: 15px; border: 2px dashed #667eea; margin: 20px 0; }
        .active-filters { background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .filter-tag { display: inline-block; background: #2196f3; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; margin: 2px 5px 2px 0; }
        .data-info { background: #e8f4fd; border: 1px solid #b8daff; border-radius: 8px; padding: 15px; margin-top: 15px; }
        .data-info h4 { color: #0c5460; margin-bottom: 10px; }
        .data-info p { color: #0c5460; margin: 0; }
        .format-info { background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-top: 15px; }
        .format-info h4 { color: #0c5460; margin-bottom: 10px; }
        .format-info p { color: #0c5460; margin: 0; font-size: 0.9rem; }
        .format-info.warning { background: #fff3cd; border-color: #ffeaa7; }
        .format-info.warning h4, .format-info.warning p { color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1><i class="fas fa-search"></i> Умный поиск должностей</h1>
                <p>Система поиска и сопоставления должностей с витринами и справочниками</p>
            </div>
        </div>

        <div class="search-section">
            <div class="file-upload-section">
                <h3 style="margin-bottom: 20px; color: #333; font-weight: 600;"><i class="fas fa-folder-open"></i> Загрузка данных</h3>
                
                <div id="formatInfo" class="format-info">
                    <h4><i class="fas fa-info-circle"></i> Статус поддержки форматов</h4>
                    <p id="formatStatus">Проверка доступности библиотек...</p>
                </div>
                
                <div class="upload-container">
                    <div class="upload-row">
                        <div class="upload-section">
                            <h4><i class="fas fa-chart-bar"></i> Витрины должностей</h4>
                            <div class="upload-area" id="uploadAreaVitriny">
                                <div class="upload-icon"><i class="fas fa-chart-bar"></i></div>
                                <div class="upload-text">
                                    <strong>Перетащите файл витрин сюда</strong>
                                    <p id="supportedFormatsVitriny">Поддерживаются: проверка...</p>
                                </div>
                                <input type="file" id="fileInputVitriny" style="display: none;">
                            </div>
                            <button class="upload-btn" id="uploadBtnVitriny"><i class="fas fa-file-upload"></i> Выбрать файл витрин</button>
                        </div>
                        <div class="upload-section">
                            <h4><i class="fas fa-list-alt"></i> Справочник должностей</h4>
                            <div class="upload-area" id="uploadAreaSprav">
                                <div class="upload-icon"><i class="fas fa-list-alt"></i></div>
                                <div class="upload-text">
                                    <strong>Перетащите справочник сюда</strong>
                                    <p id="supportedFormatsSprav">Поддерживаются: проверка...</p>
                                </div>
                                <input type="file" id="fileInputSprav" style="display: none;">
                            </div>
                            <button class="upload-btn" id="uploadBtnSprav"><i class="fas fa-file-upload"></i> Выбрать справочник</button>
                        </div>
                    </div>
                    <div class="upload-actions">
                        <button class="clear-data-btn" id="clearDataBtn" style="display: none;"><i class="fas fa-trash"></i> Очистить все данные</button>
                    </div>
                    <div id="uploadStatus" class="upload-status" style="display: none;"></div>
                </div>
            </div>

            <div class="advanced-search" id="searchSection" style="display: none;">
                <h3 style="margin-bottom: 20px; color: #333; font-weight: 600;"><i class="fas fa-search"></i> Параметры поиска</h3>
                <div class="search-row">
                    <div class="search-field">
                        <label for="blockFunction">Выберете "Блок функции"</label>
                        <select id="blockFunction" class="search-select"><option value="">-- Все блоки --</option></select>
                    </div>
                    <div class="search-field">
                        <label for="belonging">Выберете принадлежность</label>
                        <select id="belonging" class="search-select">
                            <option value="">-- Все типы --</option>
                            <option value="Корпоративный центр">Корпоративный центр</option>
                            <option value="Филиалы">Филиалы</option>
                            <option value="ОЦО">ОЦО</option>
                        </select>
                    </div>
                </div>
                <div class="search-row">
                    <div class="search-field">
                        <label for="department">Введите наименование подразделения</label>
                        <input type="text" id="department" class="search-input" placeholder="Например: Департамент...">
                    </div>
                    <div class="search-field">
                        <label for="searchInput">Введите название должности</label>
                        <input type="text" class="search-input" id="searchInput" placeholder="Например: Эксперт...">
                    </div>
                </div>
            </div>

            <div class="search-container">
                <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i> ПОИСК</button>
                <button class="clear-btn" id="clearBtn"><i class="fas fa-eraser"></i> Очистить</button>
                <button class="reset-btn" id="resetBtn"><i class="fas fa-undo"></i> Сбросить</button>
            </div>

            <div id="activeFilters" class="active-filters" style="display: none;">
                <h4>Активные фильтры:</h4>
                <div id="filtersList"></div>
            </div>

            <div class="stats">
                <div class="stat-card"><span class="stat-number" id="totalVitrinies">0</span><div class="stat-label">Записей в витринах</div></div>
                <div class="stat-card"><span class="stat-number" id="totalPositions">0</span><div class="stat-label">Уникальных должностей</div></div>
                <div class="stat-card"><span class="stat-number" id="totalSprav">0</span><div class="stat-label">Записей в справочнике</div></div>
                <div class="stat-card"><span class="stat-number" id="searchResults">0</span><div class="stat-label">Результатов поиска</div></div>
            </div>
        </div>

        <div class="results-section">
            <div id="initialMessage" class="initial-message">
                <h3><i class="fas fa-hand-paper"></i> Добро пожаловать!</h3>
                <p>Для начала работы загрузите файлы с данными.</p>
            </div>
            <div class="results-header" id="resultsHeader" style="display: none;">
                <h2 class="results-title" id="resultsTitle">Результаты поиска</h2>
                <div class="export-buttons">
                    <button class="export-btn excel-btn" id="exportExcelBtn" style="display: none;"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="export-btn csv-btn" id="exportCSVBtn"><i class="fas fa-file-csv"></i> CSV</button>
                    <button class="export-btn moyoffice-btn" id="exportMoyOfficeBtn" style="display: none;"><i class="fas fa-file-alt"></i> МойОфис</button>
                </div>
            </div>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <script>
        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
        let vitrinyData = [];
        let spravData = [];
        let currentResults = [];
        let vitrinyLoaded = false;
        let spravLoaded = false;
        let vitrinyLoadDate = null;
        let spravLoadDate = null;
        let vitrinyFileName = '';
        let spravFileName = '';
        let xlsxAvailable = false;

        // --- ИНИЦИАЛИЗАЦИЯ ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Инициализация универсальной системы поиска должностей...');
            initializeSystem();
        });

        function initializeSystem() {
            showUploadStatus('⏳ Инициализация системы...', 'loading');
            loadXLSXLibrary();
        }

        function loadXLSXLibrary() {
            console.log('📚 Попытка загрузки библиотеки XLSX...');
            
            // Список CDN для загрузки XLSX библиотеки
            const xlsxSources = [
                'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
                'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'
            ];
            
            let sourceIndex = 0;
            
            function tryLoadSource() {
                if (sourceIndex >= xlsxSources.length) {
                    console.warn('⚠️ Не удалось загрузить XLSX библиотеку из всех источников');
                    initializeWithoutXLSX();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = xlsxSources[sourceIndex];
                script.onload = function() {
                    console.log('✅ XLSX библиотека загружена из:', xlsxSources[sourceIndex]);
                    xlsxAvailable = true;
                    initializeWithXLSX();
                };
                script.onerror = function() {
                    console.warn('❌ Не удалось загрузить из:', xlsxSources[sourceIndex]);
                    sourceIndex++;
                    tryLoadSource();
                };
                document.head.appendChild(script);
            }
            
            // Проверяем, не загружена ли уже библиотека
            if (typeof XLSX !== 'undefined') {
                console.log('✅ XLSX библиотека уже доступна');
                xlsxAvailable = true;
                initializeWithXLSX();
            } else {
                tryLoadSource();
            }
        }

        function initializeWithXLSX() {
            console.log('🎉 Полная инициализация с поддержкой всех форматов');
            xlsxAvailable = true;
            updateFormatSupport(true);
            finishInitialization();
        }

        function initializeWithoutXLSX() {
            console.log('⚠️ Инициализация только с поддержкой текстовых форматов');
            xlsxAvailable = false;
            updateFormatSupport(false);
            finishInitialization();
        }

        function updateFormatSupport(hasXLSX) {
            const formatInfo = document.getElementById('formatInfo');
            const formatStatus = document.getElementById('formatStatus');
            const supportedFormatsVitriny = document.getElementById('supportedFormatsVitriny');
            const supportedFormatsSprav = document.getElementById('supportedFormatsSprav');
            const fileInputVitriny = document.getElementById('fileInputVitriny');
            const fileInputSprav = document.getElementById('fileInputSprav');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const exportMoyOfficeBtn = document.getElementById('exportMoyOfficeBtn');

            if (hasXLSX) {
                formatInfo.className = 'format-info';
                formatStatus.textContent = '✅ Полная поддержка: Excel (.xlsx, .xlsm, .xls, .ods) и текстовые форматы (.csv, .tsv, .txt)';
                supportedFormatsVitriny.textContent = 'Поддерживаются: .xlsx, .xlsm, .xls, .ods, .csv, .tsv, .txt';
                supportedFormatsSprav.textContent = 'Поддерживаются: .xlsx, .xlsm, .xls, .ods, .csv, .tsv, .txt';
                fileInputVitriny.accept = '.xlsx,.xlsm,.xls,.xods,.ods,.csv,.tsv,.txt';
                fileInputSprav.accept = '.xlsx,.xlsm,.xls,.xods,.ods,.csv,.tsv,.txt';
                exportExcelBtn.style.display = 'inline-block';
                exportMoyOfficeBtn.style.display = 'inline-block';
            } else {
                formatInfo.className = 'format-info warning';
                formatStatus.textContent = '⚠️ Ограниченная поддержка: только текстовые форматы (.csv, .tsv, .txt). Для Excel файлов сохраните их как CSV.';
                supportedFormatsVitriny.textContent = 'Поддерживаются: .csv, .tsv, .txt (для Excel сохраните как CSV)';
                supportedFormatsSprav.textContent = 'Поддерживаются: .csv, .tsv, .txt (для Excel сохраните как CSV)';
                fileInputVitriny.accept = '.csv,.tsv,.txt';
                fileInputSprav.accept = '.csv,.tsv,.txt';
                exportExcelBtn.style.display = 'none';
                exportMoyOfficeBtn.style.display = 'none';
            }
        }

        function finishInitialization() {
            try {
                setupFileUpload();
                setupEventListeners();
                console.log('✅ Система готова к работе');
                showUploadStatus('🎉 Система готова! Загрузите файлы для начала работы.', 'success');
            } catch (error) {
                console.error('❌ Ошибка при финальной инициализации:', error);
                showUploadStatus(`❌ Ошибка инициализации: ${error.message}`, 'error');
            }
        }

        // --- НАСТРОЙКА ОБРАБОТЧИКОВ СОБЫТИЙ ---
        function setupFileUpload() {
            const setupArea = (type) => {
                const fileInput = document.getElementById(`fileInput${type}`);
                const uploadArea = document.getElementById(`uploadArea${type}`);
                const uploadBtn = document.getElementById(`uploadBtn${type}`);
                if (!fileInput || !uploadArea || !uploadBtn) return;

                uploadArea.addEventListener('click', () => fileInput.click());
                uploadBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => handleFileSelect(e, type));
                ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (eventName === 'dragover') uploadArea.classList.add('dragover');
                        if (eventName === 'dragleave' || eventName === 'drop') uploadArea.classList.remove('dragover');
                        if (eventName === 'drop') handleFileDrop(e, type);
                    });
                });
            };
            setupArea('Vitriny');
            setupArea('Sprav');
        }

        function setupEventListeners() {
            document.getElementById('searchBtn')?.addEventListener('click', searchPositions);
            document.getElementById('clearBtn')?.addEventListener('click', clearResults);
            document.getElementById('resetBtn')?.addEventListener('click', resetFilters);
            document.getElementById('clearDataBtn')?.addEventListener('click', clearAllData);
            document.getElementById('exportExcelBtn')?.addEventListener('click', exportToExcel);
            document.getElementById('exportCSVBtn')?.addEventListener('click', exportToCSV);
            document.getElementById('exportMoyOfficeBtn')?.addEventListener('click', exportToMoyOffice);
            
            ['searchInput', 'department'].forEach(id => {
                 document.getElementById(id).addEventListener('keypress', e => { if (e.key === 'Enter') searchPositions(); });
            });
             ['blockFunction', 'belonging'].forEach(id => {
                document.getElementById(id).addEventListener('change', searchPositions);
            });
        }

        // --- ЛОГИКА ЗАГРУЗКИ ФАЙЛОВ ---
        function handleFileSelect(event, type) {
            const file = event.target.files[0];
            if (file) processFile(file, type);
        }

        function handleFileDrop(event, type) {
            const files = event.dataTransfer.files;
            if (files.length > 0) processFile(files[0], type);
        }

        function processFile(file, type) {
            const fileTypeName = type === 'Vitriny' ? 'витрин' : 'справочника';
            const extension = file.name.toLowerCase().split('.').pop();
            
            showUploadStatus(`Обработка файла ${fileTypeName}...`, 'loading');

            // Проверяем поддержку формата
            const excelFormats = ['xlsx', 'xlsm', 'xls', 'xods', 'ods'];
            const textFormats = ['csv', 'tsv', 'txt'];
            
            if (excelFormats.includes(extension) && !xlsxAvailable) {
                showUploadStatus(`❌ Excel файлы не поддерживаются. Сохраните файл как CSV и попробуйте снова.`, 'error');
                return;
            }
            
            if (!excelFormats.includes(extension) && !textFormats.includes(extension)) {
                showUploadStatus(`❌ Неподдерживаемый формат файла: .${extension}`, 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    console.log(`Начинаем обработку файла ${file.name} типа ${type}`);
                    let jsonData;
                    
                    if (excelFormats.includes(extension)) {
                        // Обработка Excel файлов
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                            throw new Error('Файл не содержит листов для обработки');
                        }
                        
                        const sheetName = workbook.SheetNames[0];
                        console.log(`Обрабатываем лист: ${sheetName}`);
                        jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1});
                    } else {
                        // Обработка текстовых файлов
                        const content = e.target.result;
                        jsonData = parseCSV(content);
                    }
                    
                    console.log(`Получено ${jsonData.length} строк из файла`);
                    
                    if (jsonData.length === 0) {
                        throw new Error('Файл не содержит данных');
                    }
                    
                    processTableData(jsonData, file.name, type);
                } catch (error) {
                    console.error('Ошибка парсинга файла:', error);
                    showUploadStatus(`❌ Ошибка чтения файла: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = (error) => {
                console.error('Ошибка чтения файла:', error);
                showUploadStatus('❌ Не удалось прочитать файл.', 'error');
            };
            
            if (excelFormats.includes(extension)) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        }

        // --- ПАРСИНГ CSV ---
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const result = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const delimiter = line.includes(';') ? ';' : ',';
                const cells = [];
                let currentCell = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === delimiter && !inQuotes) {
                        cells.push(currentCell.trim());
                        currentCell = '';
                    } else {
                        currentCell += char;
                    }
                }
                cells.push(currentCell.trim());
                
                const cleanedCells = cells.map(cell => cell.replace(/^"|"$/g, ''));
                result.push(cleanedCells);
            }
            
            return result;
        }

        function processTableData(jsonData, fileName, type) {
            try {
                console.log(`Обработка данных из файла ${fileName}, тип: ${type}`);
                
                if (type === 'Vitriny') {
                    vitrinyData = processVitrinyData(jsonData);
                    vitrinyLoaded = true;
                    vitrinyFileName = fileName;
                    vitrinyLoadDate = new Date();
                    console.log(`Загружено ${vitrinyData.length} записей витрин`);
                } else {
                    spravData = processSpravData(jsonData);
                    spravLoaded = true;
                    spravFileName = fileName;
                    spravLoadDate = new Date();
                    console.log(`Загружено ${spravData.length} записей справочника`);
                }
                
                showUploadStatus(`✅ Файл "${fileName}" загружен.`, 'success');
                document.getElementById('searchSection').style.display = 'block';
                document.getElementById('clearDataBtn').style.display = 'inline-block';
                updateStatsDisplay();
                
                if (vitrinyLoaded) initializeDropdowns();
                if (vitrinyLoaded && spravLoaded) enrichVitrinyWithSprav();
                
                showDataInfo(); 
                
            } catch (error) {
                console.error(`Ошибка обработки данных из файла ${fileName}:`, error);
                showUploadStatus(`❌ Ошибка обработки файла: ${error.message}`, 'error');
                
                if (type === 'Vitriny') {
                    vitrinyLoaded = false;
                    vitrinyData = [];
                } else {
                    spravLoaded = false;
                    spravData = [];
                }
            }
        }

        function cleanString(str) {
            if (!str) return '';
            return str.toString().replace(/\u00A0/g, ' ').trim();
        }

        function processVitrinyData(jsonData) {
            const headers = jsonData[0];
            const mapping = findColumnMapping(headers);
            if (mapping.position === undefined) throw new Error('Колонка "Должность" не найдена в файле витрин.');
            
            return jsonData.slice(1).map(row => {
                const position = cleanString(row[mapping.position]);
                if (!position) return null;

                const departmentParts = headers.map((h, i) => (h && h.toLowerCase().includes('подразделени') && row[i] ? cleanString(row[i]) : null)).filter(Boolean);
                
                return {
                    position: position,
                    systemName: cleanString(row[mapping.systemName]),
                    okz: cleanString(row[mapping.okz]),
                    block: cleanString(row[mapping.block]),
                    belonging: cleanString(row[mapping.belonging]),
                    department: departmentParts.join('/'),
                    comment: cleanString(row[mapping.comment]),
                    note: cleanString(row[mapping.note])
                };
            }).filter(Boolean);
        }
        
        function processSpravData(jsonData) {
            try {
                if (!jsonData || jsonData.length < 2) {
                    throw new Error('Недостаточно данных в файле справочника');
                }

                // Для CSV файлов заголовки в строке 0, для Excel может быть в строке 6
                let headerRowIndex = 0;
                let dataStartIndex = 1;
                
                // Если это выглядит как файл из Excel (много пустых строк), ищем заголовки
                if (jsonData.length > 10 && jsonData[0].length === 1 && jsonData[0][0] && jsonData[0][0].includes('Справочник')) {
                    // Ищем строку с заголовками
                    for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                        const row = jsonData[i];
                        if (row && row.length > 3 && row.some(cell => cell && cell.toLowerCase().includes('должност'))) {
                            headerRowIndex = i;
                            dataStartIndex = i + 1;
                            console.log(`Найдены заголовки в строке ${i}`);
                            break;
                        }
                    }
                }

                const headers = jsonData[headerRowIndex];
                if (!headers || headers.length === 0) {
                    throw new Error('Не удалось найти заголовки в файле справочника');
                }

                const mapping = findSpravColumnMapping(headers);
                console.log('Mapping for справочник:', mapping);
                
                if (mapping.position === undefined) {
                    console.error('Доступные заголовки:', headers);
                    throw new Error('Колонка с названием должности в справочнике не найдена.');
                }
                
                const processedData = jsonData.slice(dataStartIndex).map((row, index) => {
                    if (!row || row.length === 0) return null;
                    
                    const position = cleanString(row[mapping.position]);
                    if (!position) return null;
                    
                    return {
                        position: position,
                        systemName: cleanString(row[mapping.systemName]),
                        fullName: cleanString(row[mapping.fullName]),
                        okzCode: cleanString(row[mapping.okzCode])
                    };
                }).filter(Boolean);

                console.log(`Обработано ${processedData.length} записей из справочника`);
                return processedData;
                
            } catch (error) {
                console.error('Ошибка обработки справочника:', error);
                throw error;
            }
        }
        
        function findColumnMapping(headers) {
            const mapping = {};
            const keywords = { position: ['должност'], systemName: ['системн'], okz: ['окз'], block: ['блок функц'], belonging: ['принадлежност'], comment: ['комментар'], note: ['примечан'] };
            headers.forEach((h, i) => {
                if (!h) return;
                const header = h.toLowerCase();
                for (const key in keywords) {
                    if (keywords[key].some(kw => header.includes(kw)) && mapping[key] === undefined) mapping[key] = i;
                }
            });
            return mapping;
        }

        function findSpravColumnMapping(headers) {
            const mapping = {};
            const keywords = { 
                position: ['системное наименование', 'наименование', 'должност'], 
                systemName: ['системное имя', 'системн'], 
                fullName: ['полное наименование', 'полн'], 
                okzCode: ['код окз', 'окз'] 
            };
            
            console.log('Поиск колонок в справочнике. Заголовки:', headers);
            
            headers.forEach((h, i) => {
                if (!h) return;
                const header = h.toLowerCase().trim();
                
                for (const [key, keywordList] of Object.entries(keywords)) {
                    if (keywordList.some(kw => header.includes(kw.toLowerCase())) && mapping[key] === undefined) {
                        mapping[key] = i;
                        console.log(`Найдена колонка ${key}: индекс ${i}, заголовок "${h}"`);
                    }
                }
            });
            
            return mapping;
        }

        function enrichVitrinyWithSprav() {
            if (!vitrinyLoaded || !spravLoaded) return;

            try {
                console.log('Начинаем обогащение данных витрин справочником');
                console.log(`Витрины: ${vitrinyData.length} записей, Справочник: ${spravData.length} записей`);

                // Создаем несколько индексов для разных стратегий поиска
                const spravIndexExact = new Map();
                const spravIndexNormalized = new Map();
                const spravIndexWords = new Map();
                
                spravData.forEach((item, index) => {
                    if (item && item.position) {
                        const originalKey = item.position.toLowerCase().trim();
                        const normalizedKey = normalizePosition(item.position);
                        const wordsKey = getPositionWords(item.position);
                        
                        spravIndexExact.set(originalKey, item);
                        spravIndexNormalized.set(normalizedKey, item);
                        if (wordsKey.length > 0) {
                            spravIndexWords.set(wordsKey, item);
                        }
                    }
                });

                console.log(`Создан индекс справочника:`);
                console.log(`- Точные совпадения: ${spravIndexExact.size}`);
                console.log(`- Нормализованные: ${spravIndexNormalized.size}`);
                console.log(`- По ключевым словам: ${spravIndexWords.size}`);
                
                let matches = 0;
                let processed = 0;
                const matchDetails = [];

                vitrinyData.forEach((item, index) => {
                    processed++;
                    
                    if (!item || !item.position) {
                        return;
                    }

                    let match = null;
                    let matchType = '';

                    // Стратегия 1: Точное совпадение
                    const exactKey = item.position.toLowerCase().trim();
                    match = spravIndexExact.get(exactKey);
                    if (match) {
                        matchType = 'точное';
                    }

                    // Стратегия 2: Нормализованное совпадение
                    if (!match) {
                        const normalizedKey = normalizePosition(item.position);
                        match = spravIndexNormalized.get(normalizedKey);
                        if (match) {
                            matchType = 'нормализованное';
                        }
                    }

                    // Стратегия 3: По ключевым словам
                    if (!match) {
                        const wordsKey = getPositionWords(item.position);
                        if (wordsKey.length > 0) {
                            match = spravIndexWords.get(wordsKey);
                            if (match) {
                                matchType = 'по ключевым словам';
                            }
                        }
                    }

                    // Стратегия 4: Частичное совпадение (если основные слова совпадают)
                    if (!match) {
                        const itemWords = getPositionWords(item.position);
                        for (const [key, spravItem] of spravIndexWords.entries()) {
                            if (itemWords.length > 0 && key === itemWords) {
                                match = spravItem;
                                matchType = 'частичное';
                                break;
                            }
                        }
                    }

                    if (match) {
                        matches++;
                        
                        if (match.systemName && match.systemName !== item.systemName) {
                            item.systemName = match.systemName;
                        }
                        if (match.okzCode && match.okzCode !== item.okz) {
                            item.okz = match.okzCode;
                        }
                        if (match.fullName && match.fullName !== item.fullPositionName) {
                            item.fullPositionName = match.fullName;
                        }
                        
                        if (matches <= 10) {
                            matchDetails.push({
                                type: matchType,
                                vitriny: item.position,
                                sprav: match.position,
                                systemName: match.systemName
                            });
                            console.log(`Совпадение ${matches} (${matchType}): "${item.position}" -> "${match.position}" -> системное имя: "${match.systemName}"`);
                        }
                    }
                });

                console.log(`Обработано записей: ${processed}, найдено совпадений: ${matches}`);
                console.log('Детали первых совпадений:', matchDetails);

                if (matches > 0) {
                    showUploadStatus(`🔗 Данные обогащены. Найдено совпадений: ${matches} из ${processed}`, 'success');
                } else {
                    showUploadStatus('⚠️ Соответствий между витринами и справочником не найдено. Проверка причин...', 'warning');
                    
                    // Диагностика для отладки
                    console.log('=== ДИАГНОСТИКА ОТСУТСТВИЯ СОВПАДЕНИЙ ===');
                    console.log('Примеры должностей из витрин:');
                    vitrinyData.slice(0, 10).forEach((item, i) => {
                        if (item && item.position) {
                            console.log(`${i+1}. "${item.position}" -> нормализовано: "${normalizePosition(item.position)}" -> слова: "${getPositionWords(item.position)}"`);
                        }
                    });
                    
                    console.log('\nПримеры должностей из справочника:');
                    spravData.slice(0, 10).forEach((item, i) => {
                        if (item && item.position) {
                            console.log(`${i+1}. "${item.position}" -> нормализовано: "${normalizePosition(item.position)}" -> слова: "${getPositionWords(item.position)}"`);
                        }
                    });
                }
                
                updateStatsDisplay();
                
            } catch (error) {
                console.error('Ошибка при обогащении данных:', error);
                showUploadStatus(`❌ Ошибка при обогащении данных: ${error.message}`, 'error');
            }
        }

        // Функция нормализации названий должностей
        function normalizePosition(position) {
            if (!position) return '';
            return position
                .toLowerCase()
                .trim()
                .replace(/[^\w\s\u0400-\u04FF]/g, ' ') // Убираем спецсимволы, оставляем кириллицу и латиницу
                .replace(/\s+/g, ' ') // Убираем множественные пробелы
                .trim();
        }

        // Функция извлечения ключевых слов из должности
        function getPositionWords(position) {
            if (!position) return '';
            
            const stopWords = ['по', 'в', 'на', 'с', 'для', 'от', 'к', 'и', 'или', 'а', 'но', 'да', 'нет', 'не', 'как', 'что', 'где'];
            
            return normalizePosition(position)
                .split(' ')
                .filter(word => word.length > 2 && !stopWords.includes(word))
                .sort()
                .join(' ');
        }

        // --- ЛОГИКА ПОИСКА ---
        function searchPositions() {
            if (!vitrinyLoaded) {
                alert('Сначала загрузите файл с данными витрин');
                return;
            }
            
            try {
                showLoading();
                setTimeout(() => {
                    try {
                        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
                        const block = document.getElementById('blockFunction').value;
                        const belonging = document.getElementById('belonging').value;
                        const department = document.getElementById('department').value.trim().toLowerCase();
                        
                        currentResults = vitrinyData.filter(item => {
                            if (!item) return false;
                            
                            const matchesSearchTerm = !searchTerm || 
                                (item.position && item.position.toLowerCase().includes(searchTerm)) || 
                                (item.systemName && item.systemName.toLowerCase().includes(searchTerm));
                                
                            const matchesBlock = !block || item.block === block;
                            const matchesBelonging = !belonging || item.belonging === belonging;
                            const matchesDepartment = !department || 
                                (item.department && item.department.toLowerCase().includes(department));
                            
                            return matchesSearchTerm && matchesBlock && matchesBelonging && matchesDepartment;
                        });
                        
                        displayResults();
                        updateStatsDisplay();
                        displayActiveFilters({searchTerm, block, belonging, department});
                        
                    } catch (error) {
                        console.error('Ошибка при выполнении поиска:', error);
                        document.getElementById('resultsContainer').innerHTML = `
                            <div class="no-results">
                                <h3><i class="fas fa-exclamation-triangle"></i> Ошибка поиска</h3>
                                <p>Произошла ошибка при выполнении поиска: ${error.message}</p>
                            </div>`;
                    }
                }, 200);
                
            } catch (error) {
                console.error('Ошибка инициализации поиска:', error);
                alert('Произошла ошибка при инициализации поиска');
            }
        }

        // --- ОТОБРАЖЕНИЕ РЕЗУЛЬТАТОВ И СТАТУСОВ ---
        function showDataInfo() {
            const uploadContainer = document.querySelector('.upload-container');
            if (!uploadContainer) return;

            let infoDiv = uploadContainer.querySelector('.data-info');
            if (infoDiv) {
                infoDiv.remove();
            }

            if (!vitrinyLoaded && !spravLoaded) return;

            infoDiv = document.createElement('div');
            infoDiv.className = 'data-info';
            
            let infoHTML = '<h4><i class="fas fa-info-circle"></i> Информация о файлах</h4>';
            
            if (vitrinyLoaded) {
                const dateStr = vitrinyLoadDate ? vitrinyLoadDate.toLocaleString('ru-RU') : 'неизвестно';
                infoHTML += `<p style="margin-bottom: 5px;"><strong>Витрины:</strong> ${vitrinyFileName} (загружено: ${dateStr})</p>`;
            }
            if (spravLoaded) {
                 const dateStr = spravLoadDate ? spravLoadDate.toLocaleString('ru-RU') : 'неизвестно';
                infoHTML += `<p><strong>Справочник:</strong> ${spravFileName} (загружено: ${dateStr})</p>`;
            }
            
            infoDiv.innerHTML = infoHTML;
            uploadContainer.appendChild(infoDiv);
        }
		
		function displayResults() {
            const container = document.getElementById('resultsContainer');
            const header = document.getElementById('resultsHeader');
            document.getElementById('initialMessage').style.display = 'none';

            if (currentResults.length === 0) {
                container.innerHTML = `<div class="no-results"><h3><i class="fas fa-search"></i> Результаты не найдены</h3><p>Попробуйте изменить параметры поиска.</p></div>`;
                header.style.display = 'none';
                return;
            }

            header.style.display = 'flex';
            document.getElementById('resultsTitle').textContent = `Найдено ${currentResults.length} записей`;
            
            container.innerHTML = currentResults.map(result => `
                <div class="result-card">
                    <div class="position-title">${result.position}</div>
                    <div class="result-details">
                        <div class="detail-item"><div class="detail-label">Системное имя</div><div class="detail-value">${result.systemName || '—'}</div></div>
                        <div class="detail-item"><div class="detail-label">Полное наименование</div><div class="detail-value">${result.fullPositionName || '—'}</div></div>
                        <div class="detail-item"><div class="detail-label">ОКЗ</div><div class="detail-value">${result.okz || '—'}</div></div>
                        <div class="detail-item"><div class="detail-label">Блок функции</div><div class="detail-value">${result.block || '—'}</div></div>
                        <div class="detail-item"><div class="detail-label">Принадлежность</div><div class="detail-value">${result.belonging || '—'}</div></div>
                    </div>
                    <div class="department-path"><div class="detail-label">Путь подразделения</div><div class="detail-value">${result.department || '—'}</div></div>
                    ${result.comment ? `<div class="department-path" style="border-left-color: #17a2b8; background: #d1ecf1;"><div class="detail-label">Комментарий</div><div class="detail-value">${result.comment}</div></div>` : ''}
                    ${result.note ? `<div class="department-path" style="border-left-color: #ffc107; background: #fff3cd;"><div class="detail-label">Примечание</div><div class="detail-value">${result.note}</div></div>` : ''}
                </div>
            `).join('');
        }
        
        function showLoading() {
            document.getElementById('resultsContainer').innerHTML = `<div class="loading"><div class="spinner"></div>Поиск...</div>`;
        }
        
        function clearResults() {
            currentResults = [];
            document.getElementById('resultsContainer').innerHTML = '';
            document.getElementById('resultsHeader').style.display = 'none';
            document.getElementById('initialMessage').style.display = 'block';
            updateStatsDisplay();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('department').value = '';
            document.getElementById('blockFunction').value = '';
            document.getElementById('belonging').value = '';
            displayActiveFilters({});
            clearResults();
        }
        
        function clearAllData() {
            if (!confirm('Вы уверены, что хотите очистить все загруженные данные?')) return;
            vitrinyData = []; spravData = [];
            vitrinyLoaded = false; spravLoaded = false;
            vitrinyLoadDate = null; spravLoadDate = null;
            vitrinyFileName = ''; spravFileName = '';
            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('clearDataBtn').style.display = 'none';
            resetFilters();
            updateStatsDisplay();
            showDataInfo();
            showUploadStatus('🗑️ Все данные очищены.', 'success');
        }

        function updateStatsDisplay() {
            document.getElementById('totalVitrinies').textContent = vitrinyData.length;
            document.getElementById('totalPositions').textContent = new Set(vitrinyData.map(i => i.position)).size;
            document.getElementById('totalSprav').textContent = spravData.length;
            document.getElementById('searchResults').textContent = currentResults.length;
        }
        
        function initializeDropdowns() {
            const uniqueBlocks = [...new Set(vitrinyData.map(item => item.block).filter(Boolean))].sort();
            const blockSelect = document.getElementById('blockFunction');
            blockSelect.innerHTML = '<option value="">-- Все блоки --</option>';
            uniqueBlocks.forEach(block => {
                const option = document.createElement('option');
                option.value = block;
                option.textContent = block;
                blockSelect.appendChild(option);
            });
        }
        
        function displayActiveFilters(filters) {
            const container = document.getElementById('activeFilters');
            const list = document.getElementById('filtersList');
            list.innerHTML = '';
            let hasFilters = false;
            for (const key in filters) {
                if (filters[key]) {
                    hasFilters = true;
                    const tag = document.createElement('span');
                    tag.className = 'filter-tag';
                    tag.textContent = `${key}: ${filters[key]}`;
                    list.appendChild(tag);
                }
            }
            container.style.display = hasFilters ? 'block' : 'none';
        }
        
        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            if (!statusDiv) return;
            statusDiv.textContent = message;
            statusDiv.className = `upload-status ${type}`;
            statusDiv.style.display = 'block';
            if (type !== 'loading') setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
        }

        // --- ФУНКЦИИ ЭКСПОРТА ---
        function createExportData() {
            if (currentResults.length === 0) {
                alert('Нет данных для экспорта.');
                return null;
            }

            const headers = [
                'Должность', 'Системное имя', 'Полное наименование', 'ОКЗ', 
                'Блок функции', 'Принадлежность', 
                'Путь подразделения', 'Комментарий', 'Примечание'
            ];
            
            const data = [headers];

            currentResults.forEach(item => {
                const row = [
                    item.position || '',
                    item.systemName || '',
                    item.fullPositionName || '',
                    item.okz || '',
                    item.block || '',
                    item.belonging || '',
                    item.department || '',
                    item.comment || '',
                    item.note || ''
                ];
                data.push(row);
            });

            return data;
        }

        function exportToExcel() {
            try {
                if (!xlsxAvailable) {
                    alert('Excel экспорт недоступен. Используйте CSV экспорт.');
                    return;
                }
                
                const data = createExportData();
                if (!data) return;

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [ {wch:30}, {wch:30}, {wch:40}, {wch:15}, {wch:30}, {wch:20}, {wch:50}, {wch:40}, {wch:40} ];
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Результаты");
                XLSX.writeFile(wb, "export_results.xlsx");
                showUploadStatus('✅ Экспорт в Excel завершен.', 'success');
                
            } catch (error) {
                console.error('Ошибка экспорта в Excel:', error);
                showUploadStatus(`❌ Ошибка экспорта в Excel: ${error.message}`, 'error');
            }
        }

        function exportToCSV() {
            try {
                const data = createExportData();
                if (!data) return;

                const csvContent = data.map(row => 
                    row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(',')
                ).join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'export_results.csv';
                link.click();
                showUploadStatus('✅ Экспорт в CSV завершен.', 'success');
                
            } catch (error) {
                console.error('Ошибка экспорта в CSV:', error);
                showUploadStatus(`❌ Ошибка экспорта в CSV: ${error.message}`, 'error');
            }
        }

        function exportToMoyOffice() {
            try {
                if (!xlsxAvailable) {
                    alert('МойОфис экспорт недоступен. Используйте CSV экспорт.');
                    return;
                }
                
                const data = createExportData();
                if (!data) return;

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [ {wch:30}, {wch:30}, {wch:40}, {wch:15}, {wch:30}, {wch:20}, {wch:50}, {wch:40}, {wch:40} ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Результаты");
                XLSX.writeFile(wb, "export_results.ods", { bookType: 'ods' });
                showUploadStatus('✅ Экспорт в МойОфис (.ods) завершен.', 'success');
                
            } catch (error) {
                console.error('Ошибка экспорта в МойОфис:', error);
                showUploadStatus(`❌ Ошибка экспорта в МойОфис: ${error.message}`, 'error');
            }
        }

    </script>
</body>
</html>
